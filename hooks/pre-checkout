#!/bin/bash

# Check if the build was triggered by a webhook
if [[ -n "$BUILDKITE_BUILD_ID" ]]; then
  query='{
    "query": "query GetWebhookPayLoad { build(uuid: \"'${BUILDKITE_BUILD_ID}'\") { source { ... on BuildSourceWebhook { payload } } } }"
  }'

  response=$(curl -s https://graphql.buildkite.com/v1 \
    -H "Authorization: Bearer $BUILDKITE_API_TOKEN" \
    -H "Content-Type: application/json" \
    -d "$query")

  # Extract the repository URL from the payload (assuming the payload includes it)
  repo_url=$(echo "$response" | jq -r '.data.build.source.payload.repository_url')

  # If repo_url is found, set BUILDKITE_REPO to that value
  if [[ "$repo_url" != "null" ]]; then
    export BUILDKITE_REPO="$repo_url"
    echo "Using repository: $BUILDKITE_REPO"
  else
    echo "No webhook repository found, using default repository."
  fi
else
  echo "Build was not triggered by a webhook, using default repository."
fi
